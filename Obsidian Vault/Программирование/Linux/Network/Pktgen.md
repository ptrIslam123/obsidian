### **Что такое Pktgen?**
**Pktgen** (Packet Generator) — это высокопроизводительный генератор сетевого трафика, работающий **в ядре Linux**. Он позволяет генерировать и отправлять миллионы пакетов в секунду с минимальными накладными расходами, что делает его идеальным инструментом для:
- Тестирования производительности сети (например, пропускной способности, задержек).
- Проверки работы DPDK, XDP/eBPF, аппаратных ускорителей.
- Нагрузочного тестирования сетевых устройств (NIC, коммутаторов, файрволов).

---

## **1. Основные возможности Pktgen**
- **Генерация трафика на скорости до 100+ Gbps** (зависит от NIC и CPU).
- Поддержка **многопоточной работы** (один CPU core на очередь NIC).
- Гибкая настройка пакетов (**MAC/IP/Port/VLAN** и другие поля).
- **Статистика в реальном времени** (кол-во пакетов, битрейт, ошибки).
- Интеграция с **DPDK** (для ещё большей производительности).
- Управление через **/proc** или **скрипты Lua** (в версии `pktgen-dpdk`).

---

## **2. Версии Pktgen**
### **a) Стандартный Pktgen (в ядре Linux)**
- Встроен в ядро (`CONFIG_NET_PKTGEN`).
- Управление через `/proc/net/pktgen`.
- Пример запуска:
  ```bash
  modprobe pktgen
  echo "start" > /proc/net/pktgen/pgctrl
  ```

### **b) Pktgen-DPDK (оптимизированная версия)**
- Отдельный проект: [https://github.com/pktgen/Pktgen-DPDK](https://github.com/pktgen/Pktgen-DPDK)
- Использует **DPDK** для обхода сетевого стека ядра.
- Поддерживает **Lua-скрипты** для сложных сценариев.
- Запуск:
  ```bash
  ./app/x86_64-native-linux-gcc/pktgen -- -T -P -m "1.0" -f traffic.lua
  ```

---

## **3. Примеры использования**
### **Пример 1: Запуск Pktgen в ядре Linux**
1. Загрузите модуль:
   ```bash
   modprobe pktgen
   ```
2. Настройте интерфейс и трафик:
   ```bash
   # Добавьте интерфейс eth0 в pktgen
   echo "add_device eth0" > /proc/net/pktgen/kpktgend_0

   # Настройте пакеты (размер 64 байта, 1 млн пакетов)
   echo "count 1000000" > /proc/net/pktgen/eth0
   echo "pkt_size 64" > /proc/net/pktgen/eth0
   echo "dst 192.168.1.1" > /proc/net/pktgen/eth0
   echo "dst_mac 00:11:22:33:44:55" > /proc/net/pktgen/eth0
   ```
3. Запустите генерацию:
   ```bash
   echo "start" > /proc/net/pktgen/pgctrl
   ```
4. Результаты будут в `/proc/net/pktgen/eth0`.

---

### **Пример 2: Pktgen-DPDK (Lua-скрипт)**
1. Установите DPDK и Pktgen-DPDK.
2. Создайте скрипт `test.lua`:
   ```lua
   package.path = package.path ..";?.lua;test/?.lua;app/?.lua;"

   function main()
       local pkt = pktgen.new_pkt()
       pkt.eth_src = "00:11:22:33:44:55"
       pkt.eth_dst = "00:AA:BB:CC:DD:EE"
       pkt.ip_src = "10.0.0.1"
       pkt.ip_dst = "10.0.0.2"
       pkt.udp_sport = 1234
       pkt.udp_dport = 5678
       pkt.pkt_len = 128

       pktgen.set(0, "rate", 50) -- 50% от макс. скорости
       pktgen.start(0)
   end
   ```
3. Запустите:
   ```bash
   ./pktgen -l 0-3 -n 4 -- -T -P -m "1.0" -f test.lua
   ```

---

## **4. Ключевые команды Pktgen-DPDK**
| Команда          | Описание                          |
|------------------|-----------------------------------|
| `start 0`        | Запустить генерацию на порту 0    |
| `stop 0`         | Остановить генерацию              |
| `set 0 rate 50`  | Ограничить скорость до 50%        |
| `clear 0`        | Сбросить статистику               |
| `enable 0 arp`   | Включить ARP-запросы              |
| `pktgen.stats()` | Показать статистику в Lua         |

---

## **5. Сравнение с другими инструментами**
| Инструмент    | Производительность | Гибкость | Сложность |
|--------------|--------------------|----------|-----------|
| **Pktgen**   | ★★★★★ (ядро/DPDK) | ★★★☆     | Средняя   |
| **iperf3**   | ★★☆ (TCP/UDP)      | ★★☆      | Низкая    |
| **trex**     | ★★★★★ (DPDK)      | ★★★★★    | Высокая   |
| **Scapy**    | ★☆ (Python)        | ★★★★★    | Низкая    |

---

## **6. Полезные ссылки**
- [Официальный Pktgen-DPDK](https://github.com/pktgen/Pktgen-DPDK)
- [Документация по ядерному Pktgen](https://www.kernel.org/doc/html/latest/networking/pktgen.html)
- [Примеры Lua-скриптов](https://github.com/pktgen/Pktgen-DPDK/tree/main/lua-examples)

Transmitted
Out of buffer
* DISCARDS
* Pause rx - Количество пакетов link layer pause, полученных на физическом порту. Если этот счетчик увеличивается, это означает, что сеть перегружена и не может поглотить трафик, поступающий на адаптер.
* Pause tx - Количество пакетов паузы канального уровня, переданных на физический порт. Если этот счетчик увеличивается, это означает, что сетевой адаптер перегружен и не может поглотить трафик, поступающий из сети.
