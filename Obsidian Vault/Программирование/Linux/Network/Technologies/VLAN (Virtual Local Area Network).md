### **Технология VLAN (Virtual Local Area Network)**  
**VLAN** — это технология виртуальной локальной сети, которая позволяет логически разделить физическую сеть на несколько изолированных широковещательных доменов. Это улучшает безопасность, управление трафиком и производительность сети.

**Физическая сеть** — это обычные провода, коммутаторы и компьютеры, соединённые вместе.  **VLAN** позволяет внутри одной физической сети создать несколько **виртуальных сетей**, которые работают так, будто они отделены друг от друга.

**Пример:**  
Представь, что у тебя есть один большой коммутатор (свитч) на 24 порта.

- Без VLAN все компьютеры в этой сети видят друг друга.
- С VLAN ты можешь сказать:
    - Порт 1-8 → **VLAN 10 (Бухгалтерия)**
    - Порт 9-16 → **VLAN 20 (IT-отдел)**
    - Порт 17-24 → **VLAN 30 (Гости)**

Теперь компьютеры из **VLAN 10 не увидят** компьютеры из **VLAN 20**, даже если они подключены к одному коммутатору!

### **VLAN создаёт отдельные "широковещательные домены"**

- **Широковещательный трафик (broadcast)** — это когда компьютер отправляет сообщение **всем** в сети (например, при поиске принтера).
- Без VLAN такой трафик идёт **на все устройства** в физической сети.
- С VLAN широковещательные сообщения **остаются только внутри своей VLAN** → меньше ненужного трафика, сеть работает быстрее.

**Пример:**  
Если компьютер в **VLAN 10** отправит широковещательный запрос, его увидят **только другие компьютеры в VLAN 10**, но не в VLAN 20 или 30.

### **Компьютеры в одной VLAN могут быть в разных местах**

- Раньше, чтобы разделить сети, нужно было **физически** ставить разные коммутаторы для каждого отдела.
- С VLAN компьютеры из одной группы могут быть **где угодно** (даже в разных зданиях), но при этом оставаться в одной логической сети.

**Пример:**
- Компьютер бухгалтерии в **1-м этаже** и компьютер бухгалтерии на **5-м этаже** могут быть в **одной VLAN 10**, даже если они подключены к разным коммутаторам.

## **VLAN преодолевает географические ограничения**

- Раньше, чтобы разделить сети, нужно было **физически** ставить разные коммутаторы в разных местах.
- С VLAN можно:
    - Объединить компьютеры **из разных зданий** в одну VLAN.
    - Быстро менять группировку устройств **без переподключения проводов**.

**Пример:**
- Компьютеры бухгалтерии в **Москве** и **Санкт-Петербурге** могут быть в **одной VLAN 10**, как будто они в одной локальной сети.

## **VLAN контролирует широковещательный трафик (broadcast storms)**

- **Широковещательный трафик** (например, ARP-запросы) идёт **только внутри своей VLAN**.
- Без VLAN такой трафик заливает **всю сеть** и может её перегрузить (это называется **broadcast storm**).
- С VLAN broadcast-трафик **не выходит за пределы VLAN** → сеть стабильнее.

**Пример:**
- Если в **VLAN 20 (IT)** кто-то запустит бродкаст-шторм, **VLAN 10 (бухгалтерия)** этого даже не заметит.

## **VLAN поддерживает разные типы сетей и устройства**

- В одной VLAN могут быть:
    - **Разные скорости** (10M, 100M, 1G Ethernet).
    - **Разные технологии** (Ethernet, Wi-Fi, FDDI).
    - **Любые устройства** (компьютеры, серверы, камеры, телефоны).

**Пример:**
- В **VLAN 40 (видеонаблюдение)** могут быть:
    
    - Камеры на **100M Ethernet**
        
    - Сервер видеозаписи на **1G Ethernet**
        
    - Беспроводные камеры через **Wi-Fi**



### **VLAN Tagging (802.1Q)

VLAN Tagging — это механизм, который позволяет передавать трафик нескольких VLAN через один физический кабель (Trunk-соединение). Для этого к Ethernet-кадру добавляется специальный **VLAN Tag** (метка), указывающая, к какой VLAN относится этот кадр.  

#### **1. Зачем нужен VLAN Tagging?**  
Без тегирования VLAN коммутаторы не смогут различать трафик разных VLAN при передаче через общую среду (например, между двумя коммутаторами). Тегирование решает эту проблему, добавляя в кадр информацию о VLAN.  

### **Пример проблемы без тегирования:**  
- Есть **2 коммутатора** и **2 VLAN (10 и 20)**.  
- Если просто соединить их кабелем, коммутатор **не поймёт**, какой трафик относится к VLAN 10, а какой — к VLAN 20.  
- **Решение:** Добавить **VLAN Tag** к каждому кадру.  

---

## **2. Формат Ethernet-кадра с VLAN Tag (802.1Q)**  
Обычный Ethernet-кадр:  
```
| MAC получателя (6) | MAC отправителя (6) | EtherType (2) | Данные (46-1500) | FCS (4) |
```
Кадр с VLAN Tag (802.1Q):  
```
| MAC получателя (6) | MAC отправителя (6) | 0x8100 (2) | VLAN Tag (2) | EtherType (2) | Данные (46-1500) | FCS (4) |
```
### **Разберём поля VLAN Tag (2 байта):**  
```
| 3 бита приоритета (PCP) | 1 бит CFI | 12 бит VLAN ID |
```
- **PCP (Priority Code Point)** — приоритет трафика (0-7, используется в QoS).  
- **CFI (Canonical Format Indicator)** — флаг формата MAC-адреса (обычно 0 для Ethernet).  
- **VLAN ID (12 бит)** — номер VLAN (диапазон **1–4094**).  

**VLAN 0** и **VLAN 4095** зарезервированы и не используются.  

---

## **3. Типы портов в VLAN: Access vs Trunk**  
### **Access Port (нетегированный порт)**  
- Передаёт трафик **только одной VLAN** (без тега).  
- Подходит для подключения **конечных устройств** (ПК, камеры, принтеры).  
- **Пример настройки (Cisco):**  
  ```bash
  switchport mode access
  switchport access vlan 10
  ```

### **Trunk Port (тегированный порт)**  
- Передаёт трафик **множества VLAN** с тегами.  
- Используется для **связи между коммутаторами** или между коммутатором и маршрутизатором.  
- **Пример настройки (Cisco):**  
  ```bash
  switchport mode trunk
  switchport trunk allowed vlan 10,20,30
  ```

---

## **4. Native VLAN — Особый случай**  
- Это VLAN, **которая передаётся без тега** даже на Trunk-порту.  
- По умолчанию **Native VLAN = 1**, но её можно изменить.  
- **Важно:** Native VLAN должна **совпадать** на обоих концах Trunk-соединения, иначе возможны утечки трафика.  

### **Пример настройки Native VLAN (Cisco):**  
```bash
switchport trunk native vlan 100
```

⚠️ **Безопасность:**  
- Если злоумышленник подключится к порту в Native VLAN, он сможет видеть untagged-трафик.  
- **Рекомендация:** Менять Native VLAN на ненужную (например, 999) и не использовать её для данных.  

---

## **5. Как работает передача трафика с VLAN Tag?**  
### **Пример 1: Компьютер → Коммутатор (Access Port)**  
1. Компьютер отправляет кадр **без тега**.  
2. Коммутатор получает его на **Access Port (VLAN 10)**.  
3. Внутри коммутатора кадр **маркируется как VLAN 10**, но не передаётся с тегом наружу.  

### **Пример 2: Коммутатор → Коммутатор (Trunk Port)**  
1. Коммутатор #1 отправляет кадр с **VLAN Tag (ID=10)**.  
2. Коммутатор #2 получает его, смотрит **VLAN ID** и пересылает только в порты, относящиеся к VLAN 10.  

### **Пример 3: Маршрутизация между VLAN (Router-on-a-Stick)**  
1. Коммутатор отправляет тегированный кадр на маршрутизатор.  
2. Маршрутизатор снимает тег, определяет VLAN и перенаправляет трафик в другую VLAN.  

---

## **7. Проблемы и решения**  
### **1. VLAN Hopping (перехват VLAN)**  
- **Проблема:** Злоумышленник подделывает теги и получает доступ к чужой VLAN.  
- **Решение:**  
  - Отключать DTP (Dynamic Trunking Protocol).  
  - Не использовать VLAN 1.  
  - Фильтровать неиспользуемые VLAN на Trunk.  

### **2. Несовпадение Native VLAN**  
- **Проблема:** Трафик утекает в другую VLAN.  
- **Решение:** Вручную настраивать одинаковую Native VLAN на обоих концах.  

### **3. MTU и Giant Frames**  
- **Проблема:** VLAN Tag добавляет 4 байта → возможны проблемы с MTU.  
- **Решение:** Увеличить MTU на 4 байта (например, с 1500 до 1504).  

### **Методы разделения VLAN**  

VLAN можно настраивать разными способами в зависимости от требований сети. Рассмотрим **6 основных методов**, их **плюсы и минусы**, а также **где они применяются**.  
#### **1. VLAN на основе портов (Port-based VLAN)**  
**Как работает:**  
- VLAN назначается **физическому порту коммутатора**.  
- Все устройства, подключённые к этому порту, автоматически попадают в заданную VLAN.  

**Пример:**  
- Порт 1-8 → **VLAN 10 (Бухгалтерия)**  
- Порт 9-16 → **VLAN 20 (IT)**  

✅ **Плюсы:**  
- Простота настройки.  
- Подходит для сетей любого размера.  
- Высокая производительность (коммутатор не тратит ресурсы на анализ MAC/IP).  

❌ **Минусы:**  
- Если устройство переподключить в другой порт, VLAN не сохранится (нужно перенастраивать).  
- Не подходит для мобильных устройств (ноутбуки, телефоны).  

**Где используется:**  
- Фиксированные рабочие места (ПК в офисе).  
- Сети с чёткой структурой (например, разные VLAN для разных этажей).  

---

#### **2. VLAN на основе MAC-адресов (MAC-based VLAN)**  
**Как работает:**  
- VLAN назначается **по MAC-адресу устройства**.  
- Независимо от того, к какому порту подключено устройство, оно остаётся в своей VLAN.  

✅ **Плюсы:**  
- Удобно для мобильных пользователей (ноутбук сохраняет VLAN при переподключении).  
- Не требует перенастройки при смене порта.  

❌ **Минусы:**  
- Сложность администрирования (нужно вручную прописывать MAC-адреса).  
- Неэффективно в больших сетях (сотни устройств).  
- Если пользователь сменит сетевую карту, VLAN "сбросится".  

**Где используется:**  
- Гостиничные сети (гость подключается в любом месте и попадает в "Guest VLAN").  
- Корпоративные сети с мобильными сотрудниками.  

---

## **3. VLAN на основе протоколов (Protocol-based VLAN)**  
**Как работает:**  
- VLAN определяется **по типу трафика** (IP, IPX, AppleTalk и т. д.).  
- Например, весь VoIP-трафик (SIP/RTP) можно выделить в отдельную VLAN.  

✅ **Плюсы:**  
- Гибкость (можно разделять трафик по типу сервисов).  
- Удобно для специализированных сетей (например, промышленные протоколы).  

❌ **Минусы:**  
- Сложность настройки.  
- Низкая производительность (коммутатор анализирует не только MAC, но и заголовки сетевого уровня).  

**Где используется:**  
- Телефония (VoIP в отдельной VLAN).  
- Промышленные сети (PROFINET, Modbus).  

---

## **4. VLAN на основе IP-мультикаста (Multicast VLAN)**  
**Как работает:**  
- VLAN создаётся **для группы многоадресной рассылки (IGMP)**.  
- Устройства, подписанные на multicast-трафик (например, видеостримы), попадают в эту VLAN.  

✅ **Плюсы:**  
- Эффективность для потокового вещания (IPTV, видеоконференции).  
- Масштабируемость (можно раздавать трафик на несколько VLAN).  

❌ **Минусы:**  
- Сложность настройки.  
- Избыточность для обычных LAN.  

**Где используется:**  
- Трансляции (корпоративное TV, видеонаблюдение).  
- Конференц-связь (Webex, Zoom).  

---

## **5. VLAN на основе политик (Policy-based VLAN)**  
**Как работает:**  
- VLAN назначается **по комбинации правил**:  
  - Порт + MAC + IP + Протокол.  
- Например: "Все устройства с IP из диапазона 192.168.1.0/24 и протоколом HTTPS → VLAN 30".  

✅ **Плюсы:**  
- Максимальная гибкость.  
- Подходит для сложных корпоративных сетей.  

❌ **Минусы:**  
- Требует продвинутого оборудования (L3-коммутаторы, файрволы).  
- Сложность администрирования.  

**Где используется:**  
- Крупные компании (разделение доступа по ролям).  
- Госучреждения (разные уровни доступа).  

---

#### **6. VLAN с авторизацией (User-based VLAN, 802.1X)**  
**Как работает:**  
- Устройство попадает в VLAN **после аутентификации** (логин/пароль, сертификат).  
- Пример: сотрудник вводит учётные данные → попадает в "Employee VLAN".  

✅ **Плюсы:**  
- Высокая безопасность.  
- Динамическое назначение VLAN.  

❌ **Минусы:**  
- Требует инфраструктуры PKI/RADIUS.  
- Сложность развёртывания.  

**Где используется:**  
- Университеты (студенты/преподаватели в разных VLAN).  
- Гостевой доступ Wi-Fi (гости → изолированная VLAN).  

---

### **Вывод: какой метод выбрать?**  
| Метод                | Когда использовать?                     | Плюсы                          | Минусы                     |  
|----------------------|----------------------------------------|-------------------------------|----------------------------|  
| **Port-based**       | Фиксированные ПК, простота             | Быстро, дёшево                | Нет мобильности            |  
| **MAC-based**        | Ноутбуки, гости                        | Автоматическое перемещение     | Сложность администрирования|  
| **Protocol-based**   | VoIP, промышленные сети                | Гибкость                      | Низкая скорость            |  
| **Multicast VLAN**   | IPTV, видеоконференции                 | Эффективность                 | Сложная настройка          |  
| **Policy-based**     | Корпоративные сети с политиками        | Максимальный контроль         | Дорогое оборудование       |  
| **User-based (802.1X)| Гостевые сети, вузы                    | Безопасность                  | Требует сервер аутентификации |  

**Самый популярный метод — Port-based VLAN** (используется в 90% случаев).  
**Для Wi-Fi и мобильных устройств — MAC-based или 802.1X.**  


---

## **1. Основные принципы VLAN**
- **Логическая сегментация**  
  VLAN создает отдельные "виртуальные" сети внутри одной физической инфраструктуры. Устройства в разных VLAN не видят трафик друг друга без маршрутизации.
  
- **Изоляция широковещательного трафика (broadcast)**  
  Каждый VLAN имеет свой широковещательный домен, что уменьшает ненужный трафик и повышает производительность.

- **Гибкость настройки**  
  Устройства можно добавлять в VLAN независимо от их физического расположения.

---

## **2. Типы VLAN**
1. **По портам (Port-based VLAN)**  
   - Наиболее распространенный тип.  
   - Порты коммутатора назначаются в определенный VLAN.  
   - Пример: Порт 1-8 → VLAN 10, Порт 9-16 → VLAN 20.

2. **По MAC-адресам (MAC-based VLAN)**  
   - VLAN назначается устройству на основе его MAC-адреса.  
   - Удобно для мобильных устройств, подключающихся к разным портам.

3. **По протоколу (Protocol-based VLAN)**  
   - Разделение трафика по типу протокола (IPv4, IPv6, IPX и т. д.).  
   - Сейчас используется редко.

4. **Тегированные VLAN (802.1Q)**  
   - Используется для передачи нескольких VLAN через один физический канал (trunk).  
   - Кадры Ethernet помечаются тегом (VLAN ID).  

---

## **3. Преимущества VLAN**
✅ **Повышение безопасности** – изоляция сетевых сегментов снижает риск атак.  
✅ **Оптимизация трафика** – уменьшение широковещательного шторма (broadcast storm).  
✅ **Гибкость управления** – можно группировать устройства по функциям (например, VLAN для бухгалтерии, VLAN для отдела IT).  
✅ **Экономия оборудования** – не нужно покупать отдельные коммутаторы для каждой сети.  

---

## **4. Недостатки VLAN**
❌ **Сложность настройки** – требует грамотного администрирования.  
❌ **Ограниченная масштабируемость** – слишком большое количество VLAN может усложнить управление.  
❌ **Зависимость от коммутаторов** – не все старые устройства поддерживают VLAN.  

---

## **5. Пример использования VLAN**
**Сценарий:**  
- В компании есть три отдела: **Бухгалтерия (VLAN 10)**, **IT (VLAN 20)**, **Гости (VLAN 30)**.  
- Все они подключены к одному коммутатору, но изолированы друг от друга.  
- Через маршрутизатор можно разрешить доступ между VLAN, если это необходимо.  

---

## **6. Тегирование VLAN (802.1Q)**
- **Тег VLAN** добавляется в заголовок Ethernet-кадра.  
- **Native VLAN** – VLAN без тега (по умолчанию VLAN 1).  
- **Trunk-порты** передают трафик нескольких VLAN с тегами.  
- **Access-порты** передают трафик только одного VLAN без тегов.  
