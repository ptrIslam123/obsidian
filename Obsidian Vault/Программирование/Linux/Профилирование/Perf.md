**`perf` ‚Äî —ç—Ç–æ –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Linux, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ —Å–æ–±—ã—Ç–∏–π.**

## **1. –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã `perf`**

| –ö–æ–º–∞–Ω–¥–∞         | –û–ø–∏—Å–∞–Ω–∏–µ                                                |
| --------------- | ------------------------------------------------------- |
| `perf stat`     | –°–±–æ—Ä –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, cache-misses, –≤—Ä–µ–º—è) |
| `perf record`   | –ó–∞–ø–∏—Å—å –ø—Ä–æ—Ñ–∏–ª—è –≤ —Ñ–∞–π–ª (`perf.data`)                     |
| `perf report`   | –ê–Ω–∞–ª–∏–∑ –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è                              |
| `perf top`      | –†–µ–∂–∏–º —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (–∫–∞–∫ `top`, –Ω–æ –¥–ª—è CPU-—Ñ—É–Ω–∫—Ü–∏–π) |
| `perf annotate` | –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞—Å—Å–µ–º–±–ª–µ—Ä–Ω—ã–π –∫–æ–¥ —Å –∞–Ω–Ω–æ—Ç–∞—Ü–∏–µ–π                |
| `perf script`   | –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫—Ä–∏–ø—Ç–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏                 |

---
##  **2. –û—Å–Ω–æ–≤–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã `perf stat`**
```bash
perf stat [–æ–ø—Ü–∏–∏] [–ø—Ä–æ–≥—Ä–∞–º–º–∞]
```

| –ê—Ä–≥—É–º–µ–Ω—Ç       | –û–ø–∏—Å–∞–Ω–∏–µ                                             |
| -------------- | ---------------------------------------------------- |
| `-e <—Å–æ–±—ã—Ç–∏–µ>` | –ó–∞–º–µ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `cache-misses`) |
| `-a`           | –ó–∞–º–µ—Ä –≤—Å–µ—Ö —è–¥–µ—Ä CPU                                  |
| `-p <PID>`     | –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞                  |
| `-r <N>`       | –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã `N` —Ä–∞–∑ –∏ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤    |
| `-d`           | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (L1, LLC, TLB)                |
| `-I <–º—Å>`      | –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –≤—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏                       |
| `--per-core`   | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–∂–¥–æ–º—É —è–¥—Ä—É                           |
| `--per-socket` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ–∫–µ—Ç–∞–º CPU                            |

---
## **3. –ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (`perf list`)**

–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å:
```bash
perf list
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –≥—Ä—É–ø–ø—ã —Å–æ–±—ã—Ç–∏–π:

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è           | –ü—Ä–∏–º–µ—Ä—ã —Å–æ–±—ã—Ç–∏–π                              |
| ------------------- | -------------------------------------------- |
| **CPU-—Ü–∏–∫–ª—ã**       | `cycles`, `instructions`                     |
| **–ö—ç—à**             | `L1-dcache-load-misses`, `LLC-load-misses`   |
| **–í–µ—Ç–≤–ª–µ–Ω–∏—è**       | `branch-misses`, `branch-load-misses`        |
| **–°—Ç—Ä–∞–Ω–∏—Ü—ã –ø–∞–º—è—Ç–∏** | `page-faults`, `dTLB-load-misses`            |
| **–†–µ—Å—É—Ä—Å—ã CPU**     | `stalled-cycles-frontend`, `resource-stalls` |

---

## **4. –ê—Ä–≥—É–º–µ–Ω—Ç—ã `perf record` (–∑–∞–ø–∏—Å—å –ø—Ä–æ—Ñ–∏–ª—è)**

```bash
perf record [–æ–ø—Ü–∏–∏] [–ø—Ä–æ–≥—Ä–∞–º–º–∞]
```

|–ê—Ä–≥—É–º–µ–Ω—Ç|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|
|`-g`|–ó–∞–ø–∏—Å—å call-graph (—Å—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤)|
|`-F <—á–∞—Å—Ç–æ—Ç–∞>`|–ß–∞—Å—Ç–æ—Ç–∞ —Å–µ–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `-F 99`)|
|`-p <PID>`|–ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞|
|`-o <—Ñ–∞–π–ª>`|–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `perf.data`)|
|`-e <—Å–æ–±—ã—Ç–∏–µ>`|–ó–∞–ø–∏—Å—å –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Å–æ–±—ã—Ç–∏—é|
|`--call-graph dwarf`|–¢–æ—á–Ω—ã–π call-graph (—Ç—Ä–µ–±—É–µ—Ç `-fno-omit-frame-pointer`)|

---

## **`perf top` (—Ä–µ–∂–∏–º —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏)**

```bash
perf top [–æ–ø—Ü–∏–∏]
```

| –ê—Ä–≥—É–º–µ–Ω—Ç       | –û–ø–∏—Å–∞–Ω–∏–µ                                   |
| -------------- | ------------------------------------------ |
| `-e <—Å–æ–±—ã—Ç–∏–µ>` | –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å–æ–±—ã—Ç–∏—é                      |
| `-p <PID>`     | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞                        |
| `-K`           | –°–∫—Ä—ã—Ç—å —è–¥–µ—Ä–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏                     |
| `-U`           | –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ |

---
## **–ö—ç—à-–ø—Ä–æ–º–∞—Ö–∏/–ø–æ–ø–∞–¥–∞–Ω–∏—è**

```bash
sudo perf stat -e cache-references,cache-misses,L1-dcache-loads,L1-dcache-load-misses,LLC-loads,LLC-load-misses ./program
```
- **`cache-references`** ‚Äî –æ–±—â–µ–µ —á–∏—Å–ª–æ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –∫—ç—à—É.
- **`cache-misses`** ‚Äî –ø—Ä–æ–º–∞—Ö–∏ –≤ –∫—ç—à–µ.
	- **`L1-dcache-loads`** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ L1-–∫—ç—à–∞.
- **`L1-dcache-load-misses`** ‚Äî –ø—Ä–æ–º–∞—Ö–∏ –≤ L1.
- **`LLC-loads`** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Last-Level Cache (L3).
- **`LLC-load-misses`** ‚Äî –ø—Ä–æ–º–∞—Ö–∏ –≤ L3 (–æ—á–µ–Ω—å –¥–æ—Ä–æ–≥–∏–µ!).
### üîπ **–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è**
- –í—ã—Å–æ–∫–∏–π `L1-dcache-load-misses` ‚Üí –ü–ª–æ—Ö–∞—è –ª–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.
- –í—ã—Å–æ–∫–∏–π `LLC-load-misses` ‚Üí –ß–∞—Å—Ç—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ RAM.

## **I/O-–æ–ø–µ—Ä–∞—Ü–∏–∏ (read/write, select, epoll)**

#### **–°–æ–±—ã—Ç–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –∏ I/O:**
```bash
sudo perf stat -e syscalls:sys_enter_read,syscalls:sys_exit_read,syscalls:sys_enter_write,syscalls:sys_exit_write,syscalls:sys_enter_epoll_wait,syscalls:sys_exit_epoll_wait ./program
```

- **`syscalls:sys_enter_*`** ‚Äî –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤.
- **`syscalls:sys_exit_*`** ‚Äî –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞.

#### **–ê–Ω–∞–ª–∏–∑ `epoll` –∏ `select`**
```bash
perf stat -e 'syscalls:sys_enter_epoll*' ./program
```

–ü–æ–∫–∞–∂–µ—Ç, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤—ã–∑—ã–≤–∞–ª—Å—è `epoll_wait`.

## **NUMA-–ø—Ä–æ–º–∞—Ö–∏ (–ª–æ–∫–∞–ª—å–Ω—ã–µ vs —É–¥–∞–ª—ë–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø—ã)**

#### **–°–æ–±—ã—Ç–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ NUMA:**
```bash

```


## **–ê–Ω–∞–ª–∏–∑ CPU-—Ü–∏–∫–ª–æ–≤**
```bash
sudo perf stat -e cycles,instructions,stalled-cycles-frontend,stalled-cycles-backend,branch-misses,branch-load-misses ./program
```

- **`cycles`** ‚Äî –æ–±—â–µ–µ —á–∏—Å–ª–æ —Ü–∏–∫–ª–æ–≤ CPU.
- **`instructions`** ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
- **`stalled-cycles-frontend`** ‚Äî —Ü–∏–∫–ª—ã, –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –∏–∑-–∑–∞ –Ω–µ—Ö–≤–∞—Ç–∫–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–º–∞—Ö–æ–≤ –≤ –∫—ç—à–µ).
- **`stalled-cycles-backend`** ‚Äî —Ü–∏–∫–ª—ã, –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –∏–∑-–∑–∞ –Ω–µ—Ö–≤–∞—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–∂–∏–¥–∞–Ω–∏–µ RAM).
### üîπ **–ö–∞–∫ –Ω–∞–π—Ç–∏ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞?**
```bash
perf record -e cycles -g ./program
perf report -n --stdio | head -20
```

–ü–æ–∫–∞–∂–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–∞—Ç—è—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ CPU.


## **–ê–Ω–∞–ª–∏–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ (futex, mutex)**
##### –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `sudo perf list | grep -E 'sched:|lock:'` –¥–ª—è –æ–ø–µ—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤ —Å–∏—Å—Ç–µ–º–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

#### –ê–Ω–∞–ª–∏–∑ contention (–±–ª–æ–∫–∏—Ä–æ–≤–æ–∫)
```bash
sudo perf stat -e 'lock:contention_begin','lock:contention_end','sched:sched_stat_blocked' ./program
```
#### –ê–Ω–∞–ª–∏–∑ futex
```bash
sudo perf stat -e 'syscalls:sys_enter_futex','syscalls:sys_exit_futex' ./program
```



## –ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
```bash
sudo perf stat -e 'sched:sched_switch','sched:sched_wakeup','sched:sched_stat_runtime' ./program
```

## –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Å–æ–±—ã—Ç–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ perf(eBPF)

```bash
sudo find /sys/kernel/debug/tracing/events/
```

## –ê–Ω–∞–ª–∏–∑ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏—è–º–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ CPU

```bash
sudo perf record -F 99 -g -p <PID> -o <PERF_REPORT_FILE>
perf report -i <PERF_REPORT_FILE>
```

–ü—Ä–∏–º–µ—Ä:
```bash
sudo perf record -F 99 -g -p 374356 -o perf_data.perf
perf report -i perf_data.perf
```