**ThreadSanitizer (TSAN)** ‚Äî —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è **–≥–æ–Ω–æ–∫ –¥–∞–Ω–Ω—ã—Ö (data races)** –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö. –û–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã (runtime) –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–º–±–∏–Ω–∞—Ü–∏—é **—Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞** –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π –≥–æ–Ω–∫–∏.  

### üîπ **–ö–∞–∫ TSAN –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –≥–æ–Ω–∫–∏ –¥–∞–Ω–Ω—ã—Ö?**  

#### 1. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–º—è—Ç–∏**  
TSAN –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏ –≤ –ø–∞–º—è—Ç—å, –≤—ã–ø–æ–ª–Ω—è—è **–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ü–∏—é –∫–æ–¥–∞** (–ª–∏–±–æ –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏, –ª–∏–±–æ —á–µ—Ä–µ–∑ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É).  
- **–ó–∞–ø–∏—Å—å (write)** ‚Üí `store`  
- **–ß—Ç–µ–Ω–∏–µ (read)** ‚Üí `load`  

#### 2. **–í–µ–∫—Ç–æ—Ä–Ω—ã–µ —á–∞—Å—ã (Vector Clocks)**  
–ö–∞–∂–¥—ã–π –ø–æ—Ç–æ–∫ –∏–º–µ–µ—Ç —Å–≤–æ–π **–ª–æ–≥–∏—á–µ—Å–∫–∏–π timestamp**, –∏ TSAN —Å—Ç—Ä–æ–∏—Ç **–≤–µ–∫—Ç–æ—Ä —á–∞—Å–æ–≤** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–º—è—Ç–∏. –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ç–æ–∫–∞—Ö.  

#### 3. **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤**  
–ì–æ–Ω–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç, –µ—Å–ª–∏:  
- –î–≤–∞ –∏–ª–∏ –±–æ–ª–µ–µ –ø–æ—Ç–æ–∫–∞ –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫ –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π **–±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**
- –•–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–∑ –¥–æ—Å—Ç—É–ø–æ–≤ ‚Äî **–∑–∞–ø–∏—Å—å**  
- –î–æ—Å—Ç—É–ø—ã –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç **"–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ"** (–Ω–µ—Ç happens-before –æ—Ç–Ω–æ—à–µ–Ω–∏—è)  

TSAN —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç **–≤–µ–∫—Ç–æ—Ä–Ω—ã–µ —á–∞—Å—ã** –æ–ø–µ—Ä–∞—Ü–∏–π –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:  
‚úÖ –ï—Å–ª–∏ –µ—Å—Ç—å **—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** (–º—å—é—Ç–µ–∫—Å, –∞—Ç–æ–º–∏–∫, –±–∞—Ä—å–µ—Ä) ‚Üí –≥–æ–Ω–∫–∏ –Ω–µ—Ç.  
‚ùå –ï—Å–ª–∏ –Ω–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏ –æ–¥–∏–Ω –∏–∑ –¥–æ—Å—Ç—É–ø–æ–≤ ‚Äî –∑–∞–ø–∏—Å—å ‚Üí **–≥–æ–Ω–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞!**  

## üîπ **1. –ß—Ç–æ —Ç–∞–∫–æ–µ –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ —á–∞—Å—ã?**

**–í–µ–∫—Ç–æ—Ä–Ω—ã–µ —á–∞—Å—ã** ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è **—á–∞—Å—Ç–∏—á–Ω–æ–≥–æ —É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π** –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö (–∏–ª–∏ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö). –û–Ω–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, **–∫–∞–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –ø—Ä–æ–∏–∑–æ—à–ª–∏ –¥–æ –¥—Ä—É–≥–∏—Ö (happens-before)**.

### üî∏ **–ö–∞–∫ –≤—ã–≥–ª—è–¥—è—Ç –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ —á–∞—Å—ã?**

- –ö–∞–∂–¥—ã–π –ø–æ—Ç–æ–∫ –∏–º–µ–µ—Ç —Å–≤–æ–π **–≤–µ–∫—Ç–æ—Ä** (–º–∞—Å—Å–∏–≤) —á–∏—Å–µ–ª, –≥–¥–µ –∫–∞–∂–¥–æ–µ —á–∏—Å–ª–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–æ–≥–∏—á–µ—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ –¥—Ä—É–≥–æ–≥–æ –ø–æ—Ç–æ–∫–∞.
    
- –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —É –Ω–∞—Å 3 –ø–æ—Ç–æ–∫–∞ (`T1`, `T2`, `T3`), –∏—Ö –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ —á–∞—Å—ã –º–æ–≥—É—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:
    

- VC(T1) = [1, 0, 2]  
    VC(T2) = [0, 3, 1]  
    VC(T3) = [2, 1, 4]  
    
    –ó–¥–µ—Å—å:
    
    - `VC(T1)[1] = 0` –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ `T1` "–≤–∏–¥–∏—Ç", —á—Ç–æ `T2` –≤—ã–ø–æ–ª–Ω–∏–ª `0` –æ–ø–µ—Ä–∞—Ü–∏–π.
        
    - `VC(T3)[3] = 4` –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ `T3` —Å–∞–º –≤—ã–ø–æ–ª–Ω–∏–ª `4` –æ–ø–µ—Ä–∞—Ü–∏–∏.
        

### üî∏ **–ö–∞–∫ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ —á–∞—Å—ã?**

1. **–ü—Ä–∏ –ª–æ–∫–∞–ª—å–Ω–æ–º —Å–æ–±—ã—Ç–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –≤ –ø–æ—Ç–æ–∫–µ `T1`):**
    
    - –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–≤–æ–π —Å—á—ë—Ç—á–∏–∫:
    ```c++
  VC(T1)[1]++;  // –ë—ã–ª–æ [1,0,2], —Å—Ç–∞–ª–æ [2,0,2]  
   ```

        
- **–ü—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `T1` –æ—Ç–ø—É—Å–∫–∞–µ—Ç –º—å—é—Ç–µ–∫—Å, –∞ `T2` –µ–≥–æ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç):**
    
    - –ü–æ—Ç–æ–∫ `T2` –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–≤–æ–∏ —á–∞—Å—ã, –±–µ—Ä—è **–º–∞–∫—Å–∏–º—É–º** –∏–∑ —Å–≤–æ–µ–≥–æ –∏ `T1` –≤–µ–∫—Ç–æ—Ä–æ–≤:
    ```c++
   VC(T2) = [ max(VC(T1)[1], VC(T2)[1]), 
            max(VC(T1)[2], VC(T2)[2]), 
            max(VC(T1)[3], VC(T2)[3]) ] 
    ```
  
---

## üîπ **2. –ö–∞–∫ TSan –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ —á–∞—Å—ã –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –≥–æ–Ω–æ–∫?**

TSan **–Ω–µ —Ö—Ä–∞–Ω–∏—Ç –ø–æ–ª–Ω—ã–µ –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ —á–∞—Å—ã** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Ç–æ–∫–∞ (—ç—Ç–æ –±—ã–ª–æ –±—ã —Å–ª–∏—à–∫–æ–º –Ω–∞–∫–ª–∞–¥–Ω–æ), –∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é ‚Äî **"–ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è" (shadow state)**.

### üî∏ **Shadow State (—Ç–µ–Ω–µ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è)**

–ö–∞–∂–¥–æ–º—É **–±–∞–π—Ç—É –ø–∞–º—è—Ç–∏** —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è **–ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ—Å—Ç—É–ø** (—á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å) –≤ –≤–∏–¥–µ:

- `(thread_id, vector_clock, —Ç–∏–ø_–¥–æ—Å—Ç—É–ø–∞)`
    

–ù–∞–ø—Ä–∏–º–µ—Ä:

- –ê–¥—Ä–µ—Å `0xABCD` –±—ã–ª –∑–∞–ø–∏—Å–∞–Ω –ø–æ—Ç–æ–∫–æ–º `T1` –≤ –º–æ–º–µ–Ω—Ç `VC(T1) = [1,0,0]`.
    
- –ü–æ—Ç–æ–º –ø—Ä–æ—á–∏—Ç–∞–Ω –ø–æ—Ç–æ–∫–æ–º `T2` –≤ –º–æ–º–µ–Ω—Ç `VC(T2) = [0,1,0]`.
    

### üî∏ **–ê–ª–≥–æ—Ä–∏—Ç–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –≥–æ–Ω–∫–∏**

–ö–æ–≥–¥–∞ –ø–æ—Ç–æ–∫ `T` –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ –ø–∞–º—è—Ç–∏, TSan –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:

1. **–ë—ã–ª –ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –¥–æ—Å—Ç—É–ø –∏–∑ –¥—Ä—É–≥–æ–≥–æ –ø–æ—Ç–æ–∫–∞?**
    
    - –ï—Å–ª–∏ –¥–∞, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, **—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ª–∏ –æ–Ω–∏** (–µ—Å—Ç—å –ª–∏ happens-before).
        
2. **–ï—Å–ª–∏ happens-before –Ω–µ—Ç –∏ –æ–¥–∏–Ω –∏–∑ –¥–æ—Å—Ç—É–ø–æ–≤ ‚Äî –∑–∞–ø–∏—Å—å ‚Üí –≥–æ–Ω–∫–∞!**
    

#### üìå **–ü—Ä–∏–º–µ—Ä**

–î–æ–ø—É—Å—Ç–∏–º, —É –Ω–∞—Å –µ—Å—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è:

```c++
int x = 0;
```

–ò –¥–≤–∞ –ø–æ—Ç–æ–∫–∞:

```c++
// –ü–æ—Ç–æ–∫ T1          // –ü–æ—Ç–æ–∫ T2
x = 1;               x = 2;
```

1. **–î–æ—Å—Ç—É–ø `T1`: `x = 1`**
    
    - –ó–∞–ø–æ–º–∏–Ω–∞–µ–º: `x` –±—ã–ª –∑–∞–ø–∏—Å–∞–Ω `T1` —Å `VC(T1) = [1,0]`.
        
2. **–î–æ—Å—Ç—É–ø `T2`: `x = 2`**
    
    - –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ—Å—Ç—É–ø –∫ `x`:
        
        - –ë—ã–ª –∑–∞–ø–∏—Å–∞–Ω `T1` —Å `VC(T1) = [1,0]`.
            
        - –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å `VC(T2) = [0,1]`.
            
    - **–ù–µ—Ç happens-before!** (–ù–∏ –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç `VC(T2)` –Ω–µ –±–æ–ª—å—à–µ `VC(T1)`).
        
    - **–í—ã–≤–æ–¥:** –ì–æ–Ω–∫–∞!
        

---

## üîπ **3. –ß—Ç–æ —Ç–∞–∫–æ–µ happens-before –∏ –∫–∞–∫ –µ–≥–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç TSan?**

**Happens-before (–ø—Ä–æ–∏–∑–æ—à–ª–æ-–¥–æ)** ‚Äî —ç—Ç–æ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ **–æ–¥–Ω–æ —Å–æ–±—ã—Ç–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å –¥–æ –¥—Ä—É–≥–æ–≥–æ**.

### üî∏ **–ü—Ä–∏–º–µ—Ä—ã happens-before**

1. **–ó–∞—Ö–≤–∞—Ç –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –º—å—é—Ç–µ–∫—Å–∞:**
    
    - –ï—Å–ª–∏ `T1` –æ—Ç–ø—É—Å–∫–∞–µ—Ç –º—å—é—Ç–µ–∫—Å, –∞ `T2` –µ–≥–æ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç, —Ç–æ –≤—Å—ë, —á—Ç–æ –±—ã–ª–æ –≤ `T1` –¥–æ `unlock`, happens-before —Ç–æ–≥–æ, —á—Ç–æ –±—É–¥–µ—Ç –≤ `T2` –ø–æ—Å–ª–µ `lock`.
        
2. **–°–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞:**
    
    - `thread.join()` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏—è –≤ –ø–æ—Ç–æ–∫–µ happens-before –∫–æ–¥–∞ –ø–æ—Å–ª–µ `join()`.
        

### üî∏ **–ö–∞–∫ TSan –ø—Ä–æ–≤–µ—Ä—è–µ—Ç happens-before?**

1. –ï—Å–ª–∏ `VC(T2)[i] >= VC(T1)[i]` –¥–ª—è –≤—Å–µ—Ö `i`, —Ç–æ `T1` happens-before `T2`.
    
2. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–æ—Ä—è–¥–æ–∫ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω, –∏ –≤–æ–∑–º–æ–∂–Ω–∞ –≥–æ–Ω–∫–∞.
    

---

## üîπ **4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤ TSan**

–•—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω—ã—Ö –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö —á–∞—Å–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞–π—Ç–∞ –ø–∞–º—è—Ç–∏ –±—ã–ª–æ –±—ã —Å–ª–∏—à–∫–æ–º –¥–æ—Ä–æ–≥–æ, –ø–æ—ç—Ç–æ–º—É TSan –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:

- **–ö–æ–º–ø—Ä–µ—Å—Å–∏—é —Ç–µ–Ω–µ–≤—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–¥–∏–Ω shadow slot –ø–æ–∫—Ä—ã–≤–∞–µ—Ç 8 –±–∞–π—Ç).
    
- **–í—ã–±–æ—Ä–æ—á–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** (–Ω–µ –≤—Å–µ –¥–æ—Å—Ç—É–ø—ã –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è, —á—Ç–æ–±—ã —Å–Ω–∏–∑–∏—Ç—å –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã).
    
- **–ê–ø–ø–∞—Ä–∞—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞** (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —É—Å–∫–æ—Ä—è—é—Ç—Å—è —á–µ—Ä–µ–∑ CPU-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏).