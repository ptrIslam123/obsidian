**DPDK (Data Plane Development Kit)** — это набор библиотек и драйверов для ускорения обработки сетевых пакетов в высокопроизводительных приложениях. Он обходит стандартный сетевой стек ядра Linux, позволяя приложениям напрямую взаимодействовать с сетевыми интерфейсами (NIC) для достижения минимальных задержек и максимальной пропускной способности.

### **Основные особенности DPDK**
1. **Обход сетевого стека ядра**
    - Традиционный путь обработки пакетов в Linux (через драйверы ядра, IP-стек, TCP/UDP) создаёт значительные накладные расходы.
    - DPDK работает в пользовательском пространстве (userspace), минуя ядро, что резко снижает задержки и увеличивает скорость.
    
2. **Поддержка аппаратного ускорения**
    - Использует возможности современных сетевых карт (NIC) с поддержкой **SR-IOV**, **RSS (Receive Side Scaling)**, **TSO (TCP Segmentation Offload)** и других технологий.
    - Поддерживает **Poll Mode Drivers (PMD)** — вместо прерываний используется активный опрос (polling) для мгновенного приёма/передачи пакетов.
    
3. **Высокая производительность**
    - Может обрабатывать **десятки миллионов пакетов в секунду (Mpps)** на одном ядре CPU.
    - Минимальные задержки (менее 10 мкс).
    
4. **Поддержка виртуализации**
    - Интегрируется с **KVM, VMware, Containers** через механизмы вроде **vHost**.
    - Позволяет эффективно распределять трафик между виртуальными машинами.
    
5. **Кросс-платформенность**
    - Работает на **x86, ARM, PowerPC**.
    - Поддерживается в Linux, FreeBSD, Windows (ограниченно).
	

### **1. Стандартный путь пакета в Linux (без DPDK)**
Ваше описание корректно, но можно уточнить детали:

1. **Приём пакета сетевой картой (NIC)**:
   - Пакет попадает в **DMA-буфер** (аппаратный буфер NIC).
   - Драйвер создаёт `struct sk_buff` (или использует его из пула) и **копирует** данные из DMA-буфера в память ядра.
   - Генерируется **прерывание** (IRQ) для CPU.

2. **Обработка в ядре**:
   - **NAPI** (если активирован) переключает NIC в режим **polling** (опрос), чтобы уменьшить количество прерываний.
   - Пакет проходит через:
     - Сетевой стек (IP → TCP/UDP).
     - Механизмы фильтрации (iptables, eBPF).
     - Доставляется в **буфер сокета** (например, для `recv()`).

3. **Проблемы**:
   - **Копирование данных** (DMA → ядро → userspace).
   - **Задержки** из-за обработки в стеке ядра.
   - **Накладные расходы** на прерывания и блокировки.

---

### **Основные особенности DPDK**
1. **Обход сетевого стека ядра**
    - Традиционный путь обработки пакетов в Linux (через драйверы ядра, IP-стек, TCP/UDP) создаёт значительные накладные расходы.
    - DPDK работает в пользовательском пространстве (userspace), минуя ядро, что резко снижает задержки и увеличивает скорость.
    
2. **Поддержка аппаратного ускорения**
    - Использует возможности современных сетевых карт (NIC) с поддержкой **SR-IOV**, **RSS (Receive Side Scaling)**, **TSO (TCP Segmentation Offload)** и других технологий.
    - Поддерживает **Poll Mode Drivers (PMD)** — вместо прерываний используется активный опрос (polling) для мгновенного приёма/передачи пакетов.
    
3. **Высокая производительность**
    - Может обрабатывать **десятки миллионов пакетов в секунду (Mpps)** на одном ядре CPU.
    - Минимальные задержки (менее 10 мкс).
    
4. **Поддержка виртуализации**
    - Интегрируется с **KVM, VMware, Containers** через механизмы вроде **vHost**.
    - Позволяет эффективно распределять трафик между виртуальными машинами.
    
5. **Кросс-платформенность**
    - Работает на **x86, ARM, PowerPC**.
    - Поддерживается в Linux, FreeBSD, Windows (ограниченно).

---

Конечно! **DPDK (Data Plane Development Kit)** — это набор библиотек и драйверов с открытым исходным кодом, предназначенных для ускоренной обработки пакетов в пользовательском пространстве (user-space) на современных процессорах. Он используется в основном в сетевых приложениях, где требуется высокая производительность, низкая задержка и эффективная обработка данных.

---

## Основная цель DPDK

Обычно сетевые пакеты обрабатываются ядром операционной системы, что связано с оверхедом из-за контекстных переключений, системных вызовов и ограничений планировщика. DPDK позволяет:

- Обрабатывать пакеты **в user-space**, минуя ядро.
- Использовать **поллинг** вместо прерываний для снижения задержек.
- Максимально использовать аппаратные возможности NIC (сетевых карт).

---

## Архитектура DPDK: общий обзор

### 1. **EAL (Environment Abstraction Layer)**  
Слой абстракции окружения — основа DPDK. Отвечает за:
- Инициализацию процессора и окружающей среды.
- Управление памятью (выделение hugepages).
- Запуск потоков на разных ядрах (lcores).
- Работу с PCI-устройствами.
- Обработку аргументов командной строки.

EAL делает DPDK портируемым между разными платформами и ОС (Linux, FreeBSD, Windows).

---

### 2. **Poll Mode Drivers (PMD)**  
В отличие от традиционных драйверов, использующих прерывания, PMD работают в режиме **опроса (polling)**. Это позволяет:
- Снизить задержки.
- Избежать оверхеда от прерываний.
- Полностью контролировать обработку RX/TX очередей.

PMD поддерживает как физические NIC (например, Intel ixgbe, i40e), так и виртуальные (virtio, vhost).

---

### 3. **Memory Management**  
DPDK активно использует **hugepages** (обычно 2MB или 1GB страницы) для:
- Снижения TLB miss.
- Более быстрого доступа к памяти.
- Предсказуемого поведения.

Также реализованы:
- **Mempool**: управление блоками памяти для хранения пакетов (`rte_mempool`).
- **Mbuf**: структура данных для представления пакета (`rte_mbuf`).
- **Ring**: lock-free очередь для передачи объектов между lcore'ами.

---

### 4. **Packet Framework / Libraries**

DPDK предоставляет ряд библиотек для построения сетевых приложений:

| Название | Назначение |
|---------|------------|
| ` librte_net ` | Определения протоколов (Ethernet, VLAN, IP, TCP/UDP и т.д.) |
| ` librte_ethdev ` | Абстракция сетевых устройств, общие API для PMD |
| ` librte_ip_frag ` | Фрагментация и сборка IP-пакетов |
| ` librte_lpm ` | Longest Prefix Match для маршрутизации |
| ` librte_hash ` | Хэш-таблицы с высокой производительностью |
| ` librte_flow ` | API для классификации и фильтрации пакетов |
| ` librte_timer ` | Таймеры с точностью до микросекунд |
| ` librte_sched ` | Реализация QoS и планирования трафика |

---

### 5. **Multi-process and Multi-threading Support**

DPDK поддерживает:
- **Многопроцессное взаимодействие** через разделяемую память.
- **Многопоточность** с использованием нескольких логических ядер (lcore).
- Разделение задач между ядрами (например: одно ядро — RX, другое — обработка, третье — TX).

---

### 6. **Drivers & Hardware Offload**

DPDK поддерживает множество сетевых адаптеров (NIC) от Intel, Mellanox, Broadcom и других. Также он поддерживает аппаратные механизмы ускорения:
- **Checksum offloads**
- **TSO (TCP Segmentation Offload)**
- **VLAN filtering**
- **Flow director**
- **Crypto acceleration**

---

## Ключевые структуры данных

| Структура | Описание |
|----------|----------|
| `rte_mbuf` | Описывает сетевой пакет. Содержит указатель на данные, метаданные, ссылки на другие mbuf’ы (для фрагментированных пакетов). |
| `rte_mempool` | Пул памяти для выделения и освобождения mbuf’ов. |
| `rte_ring` | Lock-free кольцевая очередь для межпотокового обмена данными. |
| `rte_eth_dev` | Структура, представляющая сетевое устройство. |
| `rte_flow` | API для определения правил фильтрации и перенаправления пакетов. |
| `rte_lcore_id()` | Макрос для получения ID текущего логического ядра. |

---

### **2. Как работает DPDK?**
Ваше описание почти верное, но DPDK не просто "перехватывает" пакеты — он **полностью обходит ядро**. Вот детали:

#### **(1) Перехват управления NIC**
- **Rebind драйвера**:  
  DPDK заменяет стандартный драйвер Linux (например, `ixgbe`) на свой **Poll Mode Driver (PMD)**:
  ```bash
  dpdk-devbind.py --bind=vfio-pci 0000:01:00.0
  ```
  - NIC теперь управляется **напрямую из userspace** (без участия ядра).

#### **(2) Прямой доступ к пакетам**
- **DMA-буферы** отображаются в **userspace** через **UIO (Userspace I/O)** или **VFIO**.
  - Пакеты **не копируются** — они сразу доступны в памяти приложения.
- **Отсутствие `sk_buff`**:  
  DPDK использует свои структуры (например, `rte_mbuf`), оптимизированные под zero-copy.

#### **(3) Polling вместо прерываний**
- DPDK **отключает прерывания** и работает в режиме **активного опроса (polling)**:
  ```c
  while (1) {
      rte_eth_rx_burst(port_id, queue_id, pkts, BURST_SIZE);
      // Обработка пакетов...
  }
  ```
  - Это даёт **предсказуемые задержки** (но нагружает CPU).

#### **(4) Обход сетевого стека**
- **Нет TCP/IP-стека ядра**:  
  Если приложению нужна, например, маршрутизация, её реализуют **вручную** (или используют DPDK-совместимые библиотеки типа **L3fwd**).

---

### **3. Где вы немного ошиблись?**
1. **DPDK — не просто "кастомный драйвер"**:
   - Это целая **экосистема** (библиотеки для работы с очередями, памятью, криптографией и т.д.).
   - Например, для работы с виртуализацией используется **vHost**, а для ускорения — **ISA-L**.

2. **Не всегда "сразу в userspace"**:
   - Пакеты сначала попадают в **кольцевой буфер (RX-queue)** NIC, а затем DPDK забирает их оттуда батчами.

3. **Нет "кастомной обработки по слоям"**:
   - DPDK **не разбирает** автоматически заголовки Ethernet/IP/TCP — это делает приложение (или библиотеки типа **RTE Flow**).

---

### **4. DPDK vs. Современные альтернативы (XDP, io_uring)**
| Метод          | Где работает       | Задержка | Совместимость | Сложность |
|----------------|--------------------|----------|---------------|-----------|
| **DPDK**       | Userspace          | ~1–10 мкс| Низкая        | Высокая   |
| **XDP**        | Ядро (драйвер NIC) | <1 мкс   | Средняя       | Средняя   |
| **io_uring**   | Ядро → Userspace   | ~10–50 мкс| Высокая      | Низкая    |

- **XDP** (eXpress Data Path) — фильтрация и модификация пакетов **до попадания в сетевой стек** (использует eBPF).
- **io_uring** — асинхронный ввод-вывод, но без kernel bypass.

---

### **5. Когда выбирать DPDK?**
- **Высокочастотные финансовые системы** (HFT).
- **Виртуальные маршрутизаторы** (например, в NFV).
- **Серверы CDN** (Cloudflare, Facebook).
- **Телеком (5G UPF)**.


## Сборка
```bash
# устанавдливаем нужные пакеты для сборки
sudo apt install meson ninja-build python3-pyelftools libnuma-dev
git clone https://github.com/DPDK/dpdk.git
cd dpdk

# начиаем сборку проект
meson setup build # meson setup -Dbuildtype=debug -Doptimization=0 build
cd build
ninja

# запуск dpdk-testpmd
sudo ./build/app/dpdk-testpmd --help
```

## PMD(Poll Mode Driver)
https://doc.dpdk.org/guides-24.03/prog_guide/poll_mode_drv.html

https://habr.com/ru/articles/267591/
